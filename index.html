<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Dashboard Demo - Feed de Llamadas en Vivo (Demo)</title>
    <style>
        body { font-family: Arial, sans-serif; background-color: #f4f7f6; color: #333; margin: 20px; }
        .container { max-width: 900px; margin: auto; background: #fff; padding: 20px; border-radius: 8px; box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1); }
        h1, h2 { color: #007bff; border-bottom: 2px solid #eee; padding-bottom: 5px; }
        .kpi-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 20px; margin-bottom: 30px; }
        .kpi-card { background: #e9f7ff; padding: 15px; border-radius: 6px; text-align: center; border-left: 5px solid #007bff; }
        .kpi-card h3 { margin: 0; font-size: 14px; color: #555; }
        .kpi-card p { font-size: 28px; font-weight: bold; margin: 5px 0 0; }
        .details-table { width: 100%; border-collapse: collapse; margin-top: 20px; }
        .details-table th, .details-table td { text-align: left; padding: 10px; border-bottom: 1px solid #ddd; }
        .details-table th { background-color: #f0f8ff; width: 35%; }
        .error { color: red; font-weight: bold; }
        #status-bar { text-align: center; margin-bottom: 20px; padding: 10px; background: #e0ffe0; border-radius: 4px; }
    </style>
</head>
<body onload="startLiveFeed()">

    <div class="container">
        <h1>Dashboard Demo - Feed de Llamadas en Vivo (Demo)</h1>
        
        <div id="status-bar">
            <span>Última actualización: <span id="last-update">...</span></span>
        </div>

        <div id="dashboard-content">
            
            <h2 id="live-feed-title">Última Interacción</h2>
            
            <div class="kpi-grid" id="kpi-metrics">
                <p>Esperando la primera llamada...</p>
            </div>

            <h2>Detalles de Trazabilidad</h2>
            <table class="details-table">
                <tbody id="details-table-body">
                    </tbody>
            </table>
            
        </div>
        
    </div>

    <script>
        // ¡IMPORTANTE! Reemplaza esta URL con la URL de tu Worker desplegado.
        const WORKER_URL = 'https://dashboard-nxlink.ursus006.workers.dev/'; 

        let isInitialized = false; // Bandera para saber si ya se cargó la primera data

        /**
         * Función que inicia la consulta periódica (polling) al Worker.
         */
        function startLiveFeed() {
            // Llama a fetchData inmediatamente y luego cada 2 segundos.
            fetchData();
            setInterval(fetchData, 2000); // Actualiza cada 2 segundos
        }

        /**
         * Llama al Worker (GET) para obtener la lista de los últimos CDRs.
         */
        async function fetchData() {
            try {
                const response = await fetch(WORKER_URL, {
                    method: 'GET', // Pages usa GET para leer la data del Worker/KV
                });

                if (!response.ok) {
                    throw new Error(`HTTP error! status: ${response.status}`);
                }

                const allCdrData = await response.json(); // Debe devolver un array

                document.getElementById('last-update').textContent = new Date().toLocaleTimeString();
                
                if (allCdrData && allCdrData.length > 0) {
                    renderDashboard(allCdrData[0]); // Muestra el más reciente
                    isInitialized = true;
                } else if (!isInitialized) {
                    // Si no hay data y es la primera carga, muestra el mensaje de espera
                    document.getElementById('kpi-metrics').innerHTML = '<p>Esperando la primera llamada...</p>';
                    document.getElementById('details-table-body').innerHTML = '';
                }

            } catch (error) {
                console.error('Error al obtener datos del Worker:', error);
                document.getElementById('last-update').textContent = `ERROR: ${error.message}`;
            }
        }

        /**
         * Renderiza el CDR más reciente en la vista principal (KPIs y Tabla).
         */
        function renderDashboard(data) {
            const kpiGrid = document.getElementById('kpi-metrics');
            const detailsBody = document.getElementById('details-table-body');
            kpiGrid.innerHTML = '';
            detailsBody.innerHTML = '';

            // --- 1. Renderizar KPIs ---
            const kpiKeys = [
                { key: 'Duración Total', label: 'Duración (MM:SS)' },
                { key: 'Calidad de Audio (MOS)', label: 'Calidad MOS' },
                { key: 'Costo Estimado (USD)', label: 'Costo' },
                { key: 'Estado de Llamada', label: 'Resultado' }
            ];

            kpiKeys.forEach(kpi => {
                const card = document.createElement('div');
                card.className = 'kpi-card';
                card.innerHTML = `
                    <h3>${kpi.label}</h3>
                    <p>${data[kpi.key]}</p>
                `;
                kpiGrid.appendChild(card);
            });

            // --- 2. Renderizar Tabla de Detalles ---
            // Solo renderizar las claves que no fueron usadas en los KPIs
            for (const key in data) {
                if (kpiKeys.some(k => k.key === key)) continue; 

                const row = detailsBody.insertRow();
                const headerCell = row.insertCell();
                const valueCell = row.insertCell();
                
                headerCell.outerHTML = `<th>${key}</th>`;
                
                let displayValue = data[key];
                
                if (key === 'Grabación URL' && displayValue) {
                    displayValue = `<a href="${displayValue}" target="_blank">Escuchar Grabación</a>`;
                }

                valueCell.innerHTML = displayValue;
            }
        }
    </script>
</body>
</html>
